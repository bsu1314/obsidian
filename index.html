<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[obsidian]</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root { --bg: #050505; --gray: #555; --border: #1a1a1a; --active: #ff0436; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; text-transform: uppercase; }
        
        aside { width: 260px; border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; background: #000; z-index: 10; }
        #logoBtn { font-weight: bold; margin-bottom: 30px; cursor: pointer; letter-spacing: 2px; color: #fff; font-size: 1.2rem; }
        .nav-item { color: var(--gray); display: flex; align-items: center; gap: 10px; font-size: 0.7rem; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { color: #fff; }

        #fxPanel { display: none; background: #080808; border: 1px solid var(--border); padding: 12px; margin-bottom: 20px; max-height: 500px; overflow-y: auto; scrollbar-width: thin; }
        .fx-row { margin-bottom: 12px; }
        .fx-row label { font-size: 0.5rem; color: var(--gray); display: flex; justify-content: space-between; margin-bottom: 4px; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #111; }
        
        input[type="range"] { width: 100%; -webkit-appearance: none; background: #222; height: 1px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); cursor: pointer; border-radius: 0; }
        
        input[type="checkbox"] { accent-color: var(--active); cursor: pointer; }

        main { flex-grow: 1; position: relative; overflow-y: auto; padding-bottom: 150px; }
        .state-container { display: none; width: 100%; height: 100%; flex-direction: column; }
        .vault-content { padding: 40px; }
        .vault-header { display: flex; gap: 30px; margin-bottom: 40px; }
        .cover-art { width: 160px; height: 160px; background: #111; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .cover-art img { width: 100%; height: 100%; object-fit: cover; }
        
        .track-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #111; font-size: 0.7rem; color: var(--gray); gap: 15px; cursor: pointer; }
        .track-row:hover { background: #080808; }
        .track-row.active { color: var(--active); background: #0a0000; }
        .track-row.dragging { opacity: 0.4; border: 1px dashed var(--active); }
        .t-name { flex-grow: 1; }
        .t-remove { color: #333; transition: 0.2s; font-size: 18px !important; }
        .t-remove:hover { color: var(--active); }

        #playerBar { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: #000; border-top: 1px solid var(--border); display: none; flex-direction: column; z-index: 100; }
        #seekBar { width: 100%; height: 2px; -webkit-appearance: none; background: #111; cursor: pointer; outline: none; }
        #seekBar::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); border-radius: 0; }
        .player-info { display: flex; align-items: center; gap: 15px; width: 350px; }
        .player-thumb { width: 45px; height: 45px; object-fit: cover; border: 1px solid #222; }

        #dropZone.dragover { border-color: var(--active); background: #110000; }
    </style>
</head>
<body>

    <aside>
        <div id="logoBtn" onclick="location.reload()">[obsidian]</div>
        <nav>
            <div class="nav-item" onclick="showState('homeState')"><span class="material-symbols-outlined">add</span>NEW PROJECT</div>
            <div class="nav-item" onclick="showState('gridState')"><span class="material-symbols-outlined">grid_view</span>ALL PROJECTS</div>
            <div class="nav-item" onclick="toggleFx()"><span class="material-symbols-outlined">tune</span> FX </div>
            
            <div id="fxPanel">
                <canvas id="vCanvas" width="235" height="60" style="background:#000; border:1px solid #111; margin-bottom:15px;"></canvas>
                <div class="toggle-row">
                    <label style="font-size: 0.6rem; color: #fff;">CROSSFADE (5s)</label>
                    <input type="checkbox" id="xFadeToggle">
                </div>
                <div class="fx-row"><label>1. PITCH <span id="v1">1.0</span></label><input type="range" id="f1" min="0.5" max="1.5" step="0.01" value="1"></div>
                <div class="fx-row"><label>2. LOWPASS <span id="v2">20k</span></label><input type="range" id="f2" min="200" max="20000" step="1" value="20000"></div>
                <div class="fx-row"><label>3. HIGHPASS <span id="v3">0</span></label><input type="range" id="f3" min="0" max="3000" step="1" value="0"></div>
                <div class="fx-row"><label>4. DISTORT <span id="v4">0</span></label><input type="range" id="f4" min="0" max="100" step="1" value="0"></div>
                <div class="fx-row"><label>5. BASS <span id="v5">0dB</span></label><input type="range" id="f5" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>6. MID <span id="v6">0dB</span></label><input type="range" id="f6" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>7. TREBLE <span id="v7">0dB</span></label><input type="range" id="f7" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>8. COMPRESS <span id="v8">1</span></label><input type="range" id="f8" min="1" max="20" step="0.1" value="1"></div>
                <div class="fx-row"><label>9. BITCRUSH <span id="v9">16</span></label><input type="range" id="f9" min="1" max="16" step="0.1" value="16"></div>
                <div class="fx-row"><label>10. WIDTH <span id="v10">1</span></label><input type="range" id="f10" min="0" max="2" step="0.1" value="1"></div>
                <div class="fx-row"><label>11. PAN <span id="v11">0</span></label><input type="range" id="f11" min="-1" max="1" step="0.1" value="0"></div>
                <div class="fx-row"><label>12. REVERB <span id="v12">0</span></label><input type="range" id="f12" min="0" max="0.8" step="0.01" value="0"></div>
                <div class="fx-row"><label>13. MASTER <span id="v13">1.0</span></label><input type="range" id="f13" min="0" max="2" step="0.01" value="1"></div>
                <button onclick="resetFX()" style="width:100%; background:#111; color:var(--active); border:1px solid #333; font-size:0.5rem; padding:8px; cursor:pointer;">RESET ALL</button>
            </div>
            <hr style="border:0; border-top:1px solid #111; margin:15px 0;">
            <div id="sideProjects"></div>
        </nav>
    </aside>

    <main>
        <div id="homeState" class="state-container" style="display:flex;">
            <div style="display:flex; align-items:center; justify-content:center; height:100vh;">
                <div id="dropZone" style="width:450px; height:250px; border:1px dashed var(--gray); display:flex; flex-direction:column; align-items:center; justify-content:center; background:#080808; cursor:pointer;">
                    <span class="material-symbols-outlined" style="font-size:40px;">cloud_upload</span>
                    <div style="font-size:0.6rem; margin-top:15px;">DROP AUDIO OR CLICK TO START</div>
                    <input type="file" id="fileIn" multiple accept="audio/*" style="display:none;">
                </div>
            </div>
        </div>

        <div id="gridState" class="state-container">
            <div id="gridItems" style="padding:40px; display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:25px;"></div>
        </div>

        <div id="vaultState" class="state-container">
            <div class="vault-content">
                <div class="vault-header">
                    <div class="cover-art" onclick="document.getElementById('coverIn').click()">
                        <img id="vCover" src="" style="display:none;">
                        <span id="vIcon" class="material-symbols-outlined">image</span>
                    </div>
                    <input type="file" id="coverIn" accept="image/*" style="display:none;">
                    <div style="flex-grow:1;">
                        <input type="text" id="vTitle" placeholder="PROJECT TITLE" style="background:none; border:none; color:#fff; font-size:2rem; font-weight:bold; outline:none; width:100%; margin-bottom:5px;">
                        <input type="text" id="vArtist" placeholder="ARTIST NAME" style="background:none; border:none; color:var(--gray); font-size:0.8rem; outline:none; width:100%; letter-spacing:2px;">
                        <div style="margin-top:25px; display:flex; gap:10px;">
                            <button onclick="document.getElementById('appendIn').click()" style="font-size:0.5rem; background:#111; color:#eee; border:1px solid #333; padding:8px 15px; cursor:pointer;">+ ADD TRACKS</button>
                            <button onclick="deleteCurrent()" style="font-size:0.5rem; background:none; color:var(--active); border:1px solid #400; padding:8px 15px; cursor:pointer;">DELETE PROJECT</button>
                            <input type="file" id="appendIn" multiple accept="audio/*" style="display:none;">
                        </div>
                    </div>
                </div>
                <div id="trackList"></div>
            </div>
        </div>
    </main>

    <footer id="playerBar">
        <input type="range" id="seekBar" value="0">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 40px;">
            <div class="player-info">
                <img id="pThumb" src="" class="player-thumb" style="display:none;">
                <div id="pIcon" style="width:45px; height:45px; background:#111; display:flex; align-items:center; justify-content:center;"><span class="material-symbols-outlined" style="color:#333;">album</span></div>
                <div style="white-space:nowrap; overflow:hidden; margin-left:10px;">
                    <div id="pTrack" style="font-size:0.7rem; color:var(--active); font-weight:bold;">---</div>
                    <div id="pDetails" style="font-size:0.5rem; color:var(--gray);">---</div>
                </div>
            </div>
            <div style="display:flex; gap:30px;">
                <span class="material-symbols-outlined" onclick="prevNext(-1)" style="cursor:pointer">skip_previous</span>
                <span class="material-symbols-outlined" id="playBtn" style="cursor:pointer; font-size:30px;">play_circle</span>
                <span class="material-symbols-outlined" onclick="prevNext(1)" style="cursor:pointer">skip_next</span>
            </div>
            <input type="range" id="volBar" min="0" max="1" step="0.01" value="0.8" style="width:80px;">
        </div>
    </footer>

    <script>
        let db, library = [], curV = null, curT = null, audio = new Audio();
        let audioCtx, nodes = {}, isCrossfading = false;
        let draggedTrackIdx = null;

        const req = indexedDB.open("ObsidianStudio", 7);
        req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains("projects")) e.target.result.createObjectStore("projects", { keyPath: "id", autoIncrement: true }); };
        req.onsuccess = e => { db = e.target.result; sync(); };

        async function sync() {
            const tx = db.transaction("projects", "readonly");
            library = await new Promise(res => tx.objectStore("projects").getAll().onsuccess = e => res(e.target.result));
            renderSidebar(); renderGrid();
        }

        const dz = document.getElementById('dropZone');
        dz.onclick = () => document.getElementById('fileIn').click();
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        dz.addEventListener('dragover', () => dz.classList.add('dragover'), false);
        dz.addEventListener('dragleave', () => dz.classList.remove('dragover'), false);
        dz.addEventListener('drop', e => {
            dz.classList.remove('dragover');
            handleFiles(e.dataTransfer.files, false);
        }, false);

        document.getElementById('fileIn').onchange = e => handleFiles(e.target.files, false);
        document.getElementById('appendIn').onchange = e => handleFiles(e.target.files, true);

        // UPDATED HANDLEFILES WITH METADATA AUTO-ASSIGNMENT
        async function handleFiles(files, append) {
            if(!files || !files.length) return;
            
            const tracks = await Promise.all(Array.from(files).filter(f => f.type.startsWith('audio/')).map(f => {
                return new Promise(resolve => {
                    window.jsmediatags.read(f, {
                        onSuccess: function(tag) {
                            const reader = new FileReader();
                            reader.onload = ev => resolve({ 
                                title: (tag.tags.title || f.name.replace(/\.[^/.]+$/, "")).toUpperCase(), 
                                data: ev.target.result,
                                meta: tag.tags 
                            });
                            reader.readAsArrayBuffer(f);
                        },
                        onError: function() {
                            const reader = new FileReader();
                            reader.onload = ev => resolve({ 
                                title: f.name.replace(/\.[^/.]+$/, "").toUpperCase(), 
                                data: ev.target.result, 
                                meta: {} 
                            });
                            reader.readAsArrayBuffer(f);
                        }
                    });
                });
            }));

            if(tracks.length === 0) return;

            // Sort tracks by metadata track number
            tracks.sort((a, b) => (a.meta.track || 0) - (b.meta.track || 0));

            const tx = db.transaction("projects", "readwrite");
            const store = tx.objectStore("projects");

            if(append && curV !== null) {
                library[curV].tracks.push(...tracks.map(t => ({ title: t.title, data: t.data })));
                store.put(library[curV]).onsuccess = () => renderProject(curV);
            } else {
                const first = tracks[0].meta;
                let coverData = null;

                if (first.picture) {
                    const { data, format } = first.picture;
                    let base64String = "";
                    for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                    coverData = `data:${format};base64,${window.btoa(base64String)}`;
                }

                const newProject = { 
                    title: (first.album || "NEW PROJECT").toUpperCase(), 
                    artist: (first.artist || "UNKNOWN").toUpperCase(), 
                    cover: coverData, 
                    tracks: tracks.map(t => ({ title: t.title, data: t.data })) 
                };

                store.add(newProject).onsuccess = () => sync().then(() => showState('gridState'));
            }
        }

        function initAudio() {
            if(audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaElementSource(audio);
            nodes.lp = audioCtx.createBiquadFilter(); nodes.lp.type = "lowpass";
            nodes.hp = audioCtx.createBiquadFilter(); nodes.hp.type = "highpass";
            nodes.dist = audioCtx.createWaveShaper();
            nodes.comp = audioCtx.createDynamicsCompressor();
            nodes.bass = audioCtx.createBiquadFilter(); nodes.bass.type = "lowshelf"; nodes.bass.frequency.value = 200;
            nodes.mid = audioCtx.createBiquadFilter(); nodes.mid.type = "peaking"; nodes.mid.frequency.value = 1000;
            nodes.treble = audioCtx.createBiquadFilter(); nodes.treble.type = "highshelf"; nodes.treble.frequency.value = 3000;
            nodes.pan = audioCtx.createStereoPanner();
            nodes.gain = audioCtx.createGain();
            nodes.analyser = audioCtx.createAnalyser();
            nodes.analyser.fftSize = 256;

            src.connect(nodes.lp).connect(nodes.hp).connect(nodes.bass).connect(nodes.mid).connect(nodes.treble).connect(nodes.dist).connect(nodes.comp).connect(nodes.pan).connect(nodes.gain).connect(nodes.analyser).connect(audioCtx.destination);
            setupFX();
            drawWave();
        }

        function drawWave() {
            const canvas = document.getElementById('vCanvas');
            const ctx = canvas.getContext('2d');
            const data = new Uint8Array(nodes.analyser.frequencyBinCount);
            
            const render = () => {
                requestAnimationFrame(render);
                nodes.analyser.getByteFrequencyData(data);
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const barWidth = (canvas.width / data.length) * 2.5;
                let x = 0;
                for(let i=0; i<data.length; i++) {
                    let barHeight = data[i]/5;
                    ctx.fillStyle = data[i] > 200 ? '#ff0436' : '#333';
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            };
            render();
        }

        window.addEventListener('keydown', e => {
            if(e.target.tagName === 'INPUT') return;
            if(e.code === 'Space') { e.preventDefault(); audio.paused ? audio.play() : audio.pause(); }
            if(e.code === 'KeyF') toggleFx();
            if(e.code === 'KeyR') resetFX();
            if(e.code === 'ArrowRight') audio.currentTime += 5;
            if(e.code === 'ArrowLeft') audio.currentTime -= 5;
        });

        function setupFX() {
            const b = (id, n, p, d, u="") => {
                document.getElementById(id).oninput = e => {
                    if(n && p) n[p].value = parseFloat(e.target.value);
                    document.getElementById(d).innerText = e.target.value + u;
                };
            };
            document.getElementById('f1').oninput = e => { audio.playbackRate = e.target.value; document.getElementById('v1').innerText = e.target.value; };
            b('f2', nodes.lp, 'frequency', 'v2', 'Hz');
            b('f3', nodes.hp, 'frequency', 'v3', 'Hz');
            document.getElementById('f4').oninput = e => { nodes.dist.curve = makeDistCurve(e.target.value * 2); document.getElementById('v4').innerText = e.target.value; };
            b('f5', nodes.bass, 'gain', 'v5', 'dB');
            b('f6', nodes.mid, 'gain', 'v6', 'dB');
            b('f7', nodes.treble, 'gain', 'v7', 'dB');
            b('f8', nodes.comp, 'ratio', 'v8');
            b('f11', nodes.pan, 'pan', 'v11');
            b('f13', nodes.gain, 'gain', 'v13');
        }

        function makeDistCurve(a) {
            let n = 44100, curve = new Float32Array(n), deg = Math.PI / 180;
            for (let i = 0; i < n; ++i) { let x = i * 2 / n - 1; curve[i] = (3 + a) * x * 20 * deg / (Math.PI + a * Math.abs(x)); }
            return curve;
        }

        function resetFX() {
            const defs = {f1:1, f2:20000, f3:0, f4:0, f5:0, f6:0, f7:0, f8:1, f11:0, f13:1};
            Object.keys(defs).forEach(id => { let el = document.getElementById(id); el.value = defs[id]; el.dispatchEvent(new Event('input')); });
        }

        function playTrack(vi, ti) {
            initAudio();
            if(curV === vi && curT === ti && !audio.paused) { audio.pause(); } 
            else {
                isCrossfading = false;
                nodes.gain.gain.setValueAtTime(nodes.gain.gain.value, audioCtx.currentTime);
                curV = vi; curT = ti;
                const t = library[vi].tracks[ti];
                audio.src = URL.createObjectURL(new Blob([t.data], { type: 'audio/mpeg' }));
                audio.play();
                updatePlayerUI();
            }
        }

        audio.ontimeupdate = () => {
            document.getElementById('seekBar').value = (audio.currentTime / audio.duration) * 100 || 0;
            if(document.getElementById('xFadeToggle').checked && !isCrossfading && audio.duration - audio.currentTime < 5) {
                isCrossfading = true;
                const masterVol = parseFloat(document.getElementById('f13').value);
                nodes.gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 4.8);
                setTimeout(() => { prevNext(1); nodes.gain.gain.linearRampToValueAtTime(masterVol, audioCtx.currentTime + 1); }, 4800);
            }
        };

        audio.onended = () => { if(!document.getElementById('xFadeToggle').checked) prevNext(1); };
        audio.onplay = () => updatePlayerUI();
        audio.onpause = () => updatePlayerUI();

        function prevNext(dir) {
            let n = curT + dir;
            if(n >= 0 && n < library[curV].tracks.length) playTrack(curV, n);
        }

        function removeTrack(ti, event) {
            event.stopPropagation();
            if(!confirm("DELETE SONG?")) return;
            library[curV].tracks.splice(ti, 1);
            db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => renderProject(curV);
        }

        function handleDragStart(e, index) {
            draggedTrackIdx = index;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e, targetIdx) {
            e.preventDefault();
            if (draggedTrackIdx === null || draggedTrackIdx === targetIdx) return;
            const tracks = library[curV].tracks;
            const movedItem = tracks.splice(draggedTrackIdx, 1)[0];
            tracks.splice(targetIdx, 0, movedItem);
            if (curT === draggedTrackIdx) curT = targetIdx;
            else if (draggedTrackIdx < curT && targetIdx >= curT) curT--;
            else if (draggedTrackIdx > curT && targetIdx <= curT) curT++;
            db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => renderProject(curV);
            draggedTrackIdx = null;
        }

        function renderProject(idx) {
            curV = idx; const p = library[idx];
            showState('vaultState');
            document.getElementById('vTitle').value = p.title;
            document.getElementById('vArtist').value = p.artist || "";
            const img = document.getElementById('vCover');
            if(p.cover) { img.src = p.cover; img.style.display = 'block'; document.getElementById('vIcon').style.display = 'none'; }
            else { img.style.display = 'none'; document.getElementById('vIcon').style.display = 'block'; }
            
            const list = document.getElementById('trackList'); list.innerHTML = '';
            p.tracks.forEach((t, i) => {
                const isPlaying = (curT === i && !audio.paused && library[curV].id === p.id);
                const row = document.createElement('div'); 
                row.className = `track-row ${curT === i && library[curV].id === p.id ? 'active' : ''}`;
                row.draggable = true;
                row.ondragstart = (e) => handleDragStart(e, i);
                row.ondragover = (e) => handleDragOver(e);
                row.ondrop = (e) => handleDrop(e, i);
                row.ondragend = (e) => e.currentTarget.classList.remove('dragging');
                row.onclick = () => playTrack(idx, i);
                row.innerHTML = `<span class="material-symbols-outlined" style="font-size:14px">${isPlaying ? 'pause' : 'play_arrow'}</span>
                                 <div class="t-name">${t.title}</div>
                                 <span class="material-symbols-outlined t-remove" onclick="editTrackTitle(${i}, event)" style="font-size:16px!important; margin-right:10px;">edit</span>
                                 <span class="material-symbols-outlined t-remove" onclick="removeTrack(${i}, event)">delete_forever</span>`;
                list.appendChild(row);
            });
        }

        function updatePlayerUI() {
            const p = library[curV], t = p.tracks[curT];
            document.getElementById('playerBar').style.display = 'flex';
            document.getElementById('pTrack').innerText = t.title;
            document.getElementById('pDetails').innerText = `${p.artist} â€” ${p.title}`;
            if(p.cover) { document.getElementById('pThumb').src = p.cover; document.getElementById('pThumb').style.display = 'block'; document.getElementById('pIcon').style.display = 'none'; }
            else { document.getElementById('pThumb').style.display = 'none'; document.getElementById('pIcon').style.display = 'flex'; }
            document.getElementById('playBtn').innerText = audio.paused ? 'play_circle' : 'pause_circle';
            renderProject(curV);
        }

        function updateProjectField(f, v) { if(curV!==null) { library[curV][f] = v; db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => { renderSidebar(); renderGrid(); updatePlayerUI(); }; } }
        document.getElementById('vTitle').oninput = e => updateProjectField('title', e.target.value.toUpperCase());
        document.getElementById('vArtist').oninput = e => updateProjectField('artist', e.target.value.toUpperCase());
        document.getElementById('coverIn').onchange = e => { const r = new FileReader(); r.onload = ev => updateProjectField('cover', ev.target.result); r.readAsDataURL(e.target.files[0]); };
        document.getElementById('playBtn').onclick = () => audio.paused ? audio.play() : audio.pause();
        document.getElementById('volBar').oninput = e => audio.volume = e.target.value;
        document.getElementById('seekBar').oninput = e => audio.currentTime = (e.target.value / 100) * audio.duration;
        function renderSidebar() { const s = document.getElementById('sideProjects'); s.innerHTML = ''; library.forEach((p,i) => { const d = document.createElement('div'); d.className = `nav-item ${curV===i?'active':''}`; d.innerHTML = (p.cover?`<img src="${p.cover}" style="width:20px;height:20px;object-fit:cover;border:1px solid #222;"> `:`<span class="material-symbols-outlined" style="font-size:14px">album</span> `)+p.title; d.onclick = () => renderProject(i); s.appendChild(d); }); }
        function renderGrid() { const g = document.getElementById('gridItems'); g.innerHTML = ''; library.forEach((p,i) => { const c = document.createElement('div'); c.style.cssText = "border:1px solid #1a1a1a; padding:20px; background:#080808; cursor:pointer;"; c.innerHTML = (p.cover?`<img src="${p.cover}" style="width:100%; aspect-ratio:1; object-fit:cover; margin-bottom:12px;">`:`<div style="width:100%; aspect-ratio:1; background:#111; margin-bottom:12px; display:flex; align-items:center; justify-content:center;"><span class="material-symbols-outlined" style="color:#222; font-size:40px;">album</span></div>`) + `<div style="font-size:0.7rem; color:#fff;">${p.title}</div><div style="font-size:0.5rem; color:#555; margin-top:4px;">${p.artist}</div>`; c.onclick = () => renderProject(i); g.appendChild(c); }); }
        function showState(id) { document.querySelectorAll('.state-container').forEach(s => s.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }
        function toggleFx() { const p = document.getElementById('fxPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function deleteCurrent() { if(confirm("DELETE?")) { db.transaction("projects", "readwrite").objectStore("projects").delete(library[curV].id).onsuccess = () => location.reload(); } }
        
        function editTrackTitle(ti, event) {
            event.stopPropagation();
            const trackRow = event.target.closest('.track-row');
            const titleElement = trackRow.querySelector('.t-name');
            const currentTitle = library[curV].tracks[ti].title;
            const newTitle = prompt("RENAME TRACK:", currentTitle);
            if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
                const clean = newTitle.trim().toUpperCase();
                titleElement.innerText = clean;
                library[curV].tracks[ti].title = clean;
                if (curT === ti) document.getElementById('pTrack').innerText = clean;
                db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]);
            }
        }
    </script>
</body>
</html>
