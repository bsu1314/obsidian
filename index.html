<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[obsidian]</title>
    <link rel="icon" type="image/png" href="https://www.crystalsandstones.com/wp-content/uploads/2020/02/s-l640.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root { --bg: #050505; --gray: #555; --border: #1a1a1a; --active: #ff0436; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; text-transform: uppercase; }
        aside { width: 260px; border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; background: #000; z-index: 10; }
        #logoBtn { font-weight: bold; margin-bottom: 30px; cursor: pointer; letter-spacing: 2px; color: #fff; font-size: 1.2rem; }
        .nav-item { color: var(--gray); display: flex; align-items: center; gap: 10px; font-size: 0.7rem; cursor: pointer; margin-bottom: 15px; transition: 0.2s; position: relative; }
        .nav-item:hover, .nav-item.active { color: #fff; }
        .nav-item.playing-now { color: var(--active) !important; font-weight: bold; border-right: 2px solid var(--active); }
        .nav-item.drag-over { border-top: 2px solid var(--active); }

        #fxPanel { display: none; background: #080808; border: 1px solid var(--border); padding: 12px; margin-bottom: 20px; max-height: 500px; overflow-y: auto; scrollbar-width: thin; }
        .fx-row { margin-bottom: 12px; }
        .fx-row label { font-size: 0.5rem; color: var(--gray); display: flex; justify-content: space-between; margin-bottom: 4px; }
        input[type="range"] { width: 100%; -webkit-appearance: none; background: #222; height: 1px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); cursor: pointer; border-radius: 0; }
        
        main { flex-grow: 1; position: relative; overflow-y: auto; padding-bottom: 150px; }
        .state-container { display: none; width: 100%; height: 100%; flex-direction: column; }
        .vault-content { padding: 40px; display: flex; flex-direction: column; height: 100%; }
        .vault-header { display: flex; gap: 30px; margin-bottom: 40px; flex-shrink: 0; }
        .cover-art { width: 160px; height: 160px; background: #111; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .cover-art img { width: 100%; height: 100%; object-fit: cover; }
        
        #trackList { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .track-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #111; font-size: 0.7rem; color: var(--gray); gap: 15px; cursor: pointer; }
        .track-row:hover { background: #080808; }
        .track-row.active { color: var(--active); background: #0a0000; }
        .track-row.drag-over { border-top: 2px solid var(--active); }
        .t-name { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        .t-edit-input { background: #111; border: 1px solid var(--active); color: #fff; font-family: inherit; font-size: 0.7rem; padding: 2px 5px; width: 80%; text-transform: uppercase; }
        .t-icon-btn { font-size: 14px !important; color: #333; cursor: pointer; }
        .t-icon-btn:hover { color: #fff; }

        #playerBar { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: #000; border-top: 1px solid var(--border); display: none; flex-direction: column; z-index: 100; }
        #seekBar { width: 100%; height: 2px; -webkit-appearance: none; background: #111; cursor: pointer; outline: none; }
        #seekBar::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); }
        .big-play-btn { margin-top: 15px; width: 160px; background: var(--active); color: #fff; border: none; padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
    </style>
</head>
<body>

    <aside>
        <div id="logoBtn" onclick="location.reload()">[obsidian]</div>
        <nav>
            <div class="nav-item" onclick="showState('homeState')"><span class="material-symbols-outlined">add</span>NEW PROJECT</div>
            <div class="nav-item" onclick="showState('gridState')"><span class="material-symbols-outlined">grid_view</span>ALL PROJECTS</div>
            <div class="nav-item" onclick="toggleFx()"><span class="material-symbols-outlined">tune</span> FX </div>
            
            <div id="fxPanel">
                <canvas id="vCanvas" width="235" height="60" style="background:#000; border:1px solid #111; margin-bottom:15px;"></canvas>
                <div class="fx-row"><label>1. PITCH <span id="v1">1.0</span></label><input type="range" id="f1" min="0.5" max="1.5" step="0.01" value="1"></div>
                <div class="fx-row"><label>2. LOWPASS <span id="v2">20k</span></label><input type="range" id="f2" min="200" max="20000" step="1" value="20000"></div>
                <div class="fx-row"><label>3. HIGHPASS <span id="v3">0</span></label><input type="range" id="f3" min="0" max="3000" step="1" value="0"></div>
                <div class="fx-row"><label>4. DISTORT <span id="v4">0</span></label><input type="range" id="f4" min="0" max="100" step="1" value="0"></div>
                <button onclick="resetFX()" style="width:100%; background:#111; color:var(--active); border:1px solid #333; font-size:0.5rem; padding:8px; cursor:pointer;">RESET ALL</button>
            </div>
            <hr style="border:0; border-top:1px solid #111; margin:15px 0;">
            <div id="sideProjects"></div>
        </nav>
    </aside>

    <main>
        <div id="homeState" class="state-container" style="display:flex;">
            <div style="display:flex; align-items:center; justify-content:center; height:100vh; width:100%;">
                <div id="dropZone" style="width:450px; height:250px; border:1px dashed var(--gray); display:flex; flex-direction:column; align-items:center; justify-content:center; background:#080808; cursor:pointer;">
                    <span class="material-symbols-outlined" style="font-size:40px;">cloud_upload</span>
                    <div style="font-size:0.6rem; margin-top:15px;">DROP AUDIO OR CLICK TO START</div>
                    <input type="file" id="fileIn" multiple accept="audio/*" style="display:none;">
                </div>
            </div>
        </div>

        <div id="gridState" class="state-container">
            <div id="gridItems" style="padding:40px; display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:25px;"></div>
        </div>

        <div id="vaultState" class="state-container">
            <div class="vault-content">
                <div class="vault-header">
                    <div>
                        <div class="cover-art" id="vaultCoverZone" onclick="document.getElementById('coverIn').click()">
                            <img id="vCover" src="" style="display:none;">
                            <span id="vIcon" class="material-symbols-outlined">image</span>
                        </div>
                        <button class="big-play-btn" id="bigPlayBtn"><span class="material-symbols-outlined" style="font-size:16px;">play_arrow</span> PLAY PROJECT</button>
                    </div>
                    <input type="file" id="coverIn" accept="image/*" style="display:none;">
                    <div style="flex-grow:1;">
                        <input type="text" id="vTitle" placeholder="PROJECT TITLE" style="background:none; border:none; color:#fff; font-size:2rem; font-weight:bold; outline:none; width:100%; margin-bottom:5px;">
                        <input type="text" id="vArtist" placeholder="ARTIST NAME" style="background:none; border:none; color:var(--gray); font-size:0.8rem; outline:none; width:100%; letter-spacing:2px;">
                        <div style="margin-top:25px; display:flex; gap:10px;">
                            <button onclick="document.getElementById('appendIn').click()" style="font-size:0.5rem; background:#111; color:#eee; border:1px solid #333; padding:8px 15px; cursor:pointer;">+ ADD TRACKS</button>
                            <button onclick="deleteCurrent()" style="font-size:0.5rem; background:none; color:var(--active); border:1px solid #400; padding:8px 15px; cursor:pointer;">DELETE PROJECT</button>
                            <input type="file" id="appendIn" multiple accept="audio/*" style="display:none;">
                        </div>
                    </div>
                </div>
                <div id="trackList"></div>
            </div>
        </div>
    </main>

    <footer id="playerBar">
        <input type="range" id="seekBar" value="0">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 40px;">
            <div id="pTrackInfo" style="width: 300px; white-space:nowrap; overflow:hidden;">
                <div id="pTrack" style="font-size:0.7rem; color:var(--active); font-weight:bold;">---</div>
                <div id="pDetails" style="font-size:0.5rem; color:var(--gray);">---</div>
            </div>
            <div style="display:flex; gap:30px;">
                <span class="material-symbols-outlined" onclick="prevNext(-1)" style="cursor:pointer">skip_previous</span>
                <span class="material-symbols-outlined" id="playBtn" style="cursor:pointer; font-size:30px;">play_circle</span>
                <span class="material-symbols-outlined" onclick="prevNext(1)" style="cursor:pointer">skip_next</span>
            </div>
            <input type="range" id="volBar" min="0" max="1" step="0.01" value="0.8" style="width:80px;">
        </div>
    </footer>

    <script>
        let db, library = [], curV = null, curT = null, audio = new Audio();
        let audioCtx, nodes = {}, playingProjectId = null;
        let dragSource = null;

        const req = indexedDB.open("ObsidianStudio", 10);
        req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains("projects")) e.target.result.createObjectStore("projects", { keyPath: "id", autoIncrement: true }); };
        req.onsuccess = e => { db = e.target.result; sync(); };

        async function sync() {
            const tx = db.transaction("projects", "readonly");
            library = await new Promise(res => tx.objectStore("projects").getAll().onsuccess = e => res(e.target.result));
            renderSidebar(); renderGrid();
            if(curV !== null) renderProject(curV);
        }

        function showState(id) { document.querySelectorAll('.state-container').forEach(s => s.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }

        // Audio and Files...
        const dz = document.getElementById('dropZone');
        dz.onclick = () => document.getElementById('fileIn').click();
        ['dragover', 'drop'].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
        document.getElementById('fileIn').onchange = e => handleFiles(e.target.files, false);
        document.getElementById('appendIn').onchange = e => handleFiles(e.target.files, true);

        async function handleFiles(files, append) {
            if(!files.length) return;
            const tracks = await Promise.all(Array.from(files).filter(f => f.type.startsWith('audio/')).map(f => {
                return new Promise(resolve => {
                    window.jsmediatags.read(f, {
                        onSuccess: (tag) => {
                            const reader = new FileReader();
                            reader.onload = ev => resolve({ title: (tag.tags.title || f.name.split('.')[0]).toUpperCase(), data: ev.target.result });
                            reader.readAsArrayBuffer(f);
                        },
                        onError: () => {
                            const reader = new FileReader();
                            reader.onload = ev => resolve({ title: f.name.split('.')[0].toUpperCase(), data: ev.target.result });
                            reader.readAsArrayBuffer(f);
                        }
                    });
                });
            }));

            const tx = db.transaction("projects", "readwrite");
            const store = tx.objectStore("projects");
            if(append && curV !== null) {
                library[curV].tracks.push(...tracks);
                store.put(library[curV]).onsuccess = () => renderProject(curV);
            } else {
                const newProject = { title: "NEW PROJECT", artist: "UNKNOWN", cover: null, tracks: tracks };
                store.add(newProject);
            }
            tx.oncomplete = () => sync().then(() => !append && showState('gridState'));
        }

        // Drag & Drop Handlers
        function setupDraggable(el, type, index) {
            el.draggable = true;
            el.ondragstart = e => { dragSource = { type, index }; e.dataTransfer.effectAllowed = 'move'; };
            el.ondragover = e => { e.preventDefault(); el.classList.add('drag-over'); };
            el.ondragleave = () => el.classList.remove('drag-over');
            el.ondrop = e => {
                e.preventDefault();
                el.classList.remove('drag-over');
                if (dragSource.type !== type) return;
                reorder(dragSource.index, index, type);
            };
        }

        async function reorder(from, to, type) {
            if (from === to) return;
            if (type === 'project') {
                const moved = library.splice(from, 1)[0];
                library.splice(to, 0, moved);
                // In a real app we'd update every record's 'order' field, 
                // but here we rewrite the order based on the current array.
                const tx = db.transaction("projects", "readwrite");
                const store = tx.objectStore("projects");
                await store.clear();
                library.forEach(p => { delete p.id; store.add(p); });
                tx.oncomplete = () => sync();
            } else if (type === 'track') {
                const moved = library[curV].tracks.splice(from, 1)[0];
                library[curV].tracks.splice(to, 0, moved);
                db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => renderProject(curV);
            }
        }

        // Project Rendering
        function renderProject(idx) {
            curV = idx; const p = library[idx];
            showState('vaultState');
            document.getElementById('vTitle').value = p.title;
            document.getElementById('vArtist').value = p.artist;
            
            const list = document.getElementById('trackList'); list.innerHTML = '';
            p.tracks.forEach((t, i) => {
                const isPlaying = (curT === i && !audio.paused && playingProjectId === p.id);
                const row = document.createElement('div'); row.className = `track-row ${isPlaying?'active':''}`;
                setupDraggable(row, 'track', i);

                row.innerHTML = `
                    <span class="material-symbols-outlined" style="font-size:14px">${isPlaying?'pause':'play_arrow'}</span>
                    <div class="t-name" id="t-container-${i}">
                        <span id="t-text-${i}">${t.title}</span>
                        <span class="material-symbols-outlined t-icon-btn" onclick="editTrackTitle(${i}, event)">edit</span>
                    </div>
                    <span class="material-symbols-outlined t-remove" onclick="removeTrack(${i}, event)">delete_forever</span>
                `;
                row.onclick = (e) => { if(e.target.tagName !== 'INPUT' && !e.target.classList.contains('t-icon-btn')) playTrack(idx, i); };
                list.appendChild(row);
            });
        }

        function editTrackTitle(i, event) {
            event.stopPropagation();
            const container = document.getElementById(`t-container-${i}`);
            const originalTitle = library[curV].tracks[i].title;
            container.innerHTML = `<input type="text" class="t-edit-input" id="edit-input-${i}" value="${originalTitle}">`;
            const input = document.getElementById(`edit-input-${i}`);
            input.focus();
            input.onblur = () => saveTrackTitle(i, input.value);
            input.onkeydown = e => { if(e.key === 'Enter') saveTrackTitle(i, input.value); };
        }

        function saveTrackTitle(i, newTitle) {
            if (newTitle.trim() !== "") {
                library[curV].tracks[i].title = newTitle.toUpperCase();
                db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => renderProject(curV);
            } else {
                renderProject(curV);
            }
        }

        function renderSidebar() {
            const s = document.getElementById('sideProjects'); s.innerHTML = '';
            library.forEach((p, i) => {
                const d = document.createElement('div'); d.className = `nav-item ${curV===i?'active':''} ${p.id===playingProjectId?'playing-now':''}`;
                d.innerHTML = `<span class="material-symbols-outlined">album</span> ${p.title}`;
                setupDraggable(d, 'project', i);
                d.onclick = () => renderProject(i); s.appendChild(d);
            });
        }

        function renderGrid() {
            const g = document.getElementById('gridItems'); g.innerHTML = '';
            library.forEach((p, i) => {
                const c = document.createElement('div'); c.style.cssText = "border:1px solid #1a1a1a; padding:20px; background:#080808; cursor:pointer;";
                c.innerHTML = `<div style="width:100%; aspect-ratio:1; background:#111; display:flex; align-items:center; justify-content:center; margin-bottom:12px;"><span class="material-symbols-outlined" style="font-size:40px; color:#222">album</span></div><div style="font-size:0.7rem;">${p.title}</div>`;
                c.onclick = () => renderProject(i); g.appendChild(c);
            });
        }

        // Rest of Audio Engine and FX (Existing logic)...
        function playTrack(vi, ti) {
            if(!audioCtx) initAudio();
            playingProjectId = library[vi].id; curV = vi; curT = ti;
            audio.src = URL.createObjectURL(new Blob([library[vi].tracks[ti].data]));
            audio.play();
            updatePlayerUI();
        }

        function updatePlayerUI() {
            const p = library.find(lp => lp.id === playingProjectId);
            if(!p) return;
            document.getElementById('playerBar').style.display = 'flex';
            document.getElementById('pTrack').innerText = p.tracks[curT].title;
            document.getElementById('pDetails').innerText = `${p.artist} â€” ${p.title}`;
            document.getElementById('playBtn').innerText = audio.paused ? 'play_circle' : 'pause_circle';
            renderSidebar();
            if(curV !== null && library[curV].id === playingProjectId) renderProject(curV);
        }

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaElementSource(audio);
            nodes.lp = audioCtx.createBiquadFilter(); nodes.lp.type = "lowpass";
            nodes.hp = audioCtx.createBiquadFilter(); nodes.hp.type = "highpass";
            nodes.dist = audioCtx.createWaveShaper();
            nodes.gain = audioCtx.createGain();
            nodes.analyser = audioCtx.createAnalyser();
            src.connect(nodes.lp).connect(nodes.hp).connect(nodes.dist).connect(nodes.gain).connect(nodes.analyser).connect(audioCtx.destination);
            drawWave();
        }

        function drawWave() {
            const canvas = document.getElementById('vCanvas'), ctx = canvas.getContext('2d');
            const data = new Uint8Array(nodes.analyser.frequencyBinCount);
            const render = () => {
                requestAnimationFrame(render);
                nodes.analyser.getByteFrequencyData(data);
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                for(let i=0; i<30; i++) {
                    ctx.fillStyle = data[i*2] > 200 ? '#ff0436' : '#333';
                    ctx.fillRect(i*8, canvas.height - data[i*2]/4, 6, data[i*2]/4);
                }
            }; render();
        }

        function resetFX() {
            audio.playbackRate = 1;
            if(audioCtx) { nodes.lp.frequency.value = 20000; nodes.hp.frequency.value = 0; nodes.dist.curve = null; nodes.gain.gain.value = 1; }
            sync();
        }

        function toggleFx() { const p = document.getElementById('fxPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function deleteCurrent() { if(confirm("DELETE PROJECT?")) { db.transaction("projects", "readwrite").objectStore("projects").delete(library[curV].id).onsuccess = () => location.reload(); } }
        function removeTrack(ti, e) { e.stopPropagation(); if(confirm("DELETE TRACK?")) { library[curV].tracks.splice(ti, 1); db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => renderProject(curV); } }
        
        document.getElementById('playBtn').onclick = () => { audio.paused ? audio.play() : audio.pause(); updatePlayerUI(); };
        audio.ontimeupdate = () => { document.getElementById('seekBar').value = (audio.currentTime / audio.duration) * 100 || 0; };
        audio.onended = () => prevNext(1);
        function prevNext(dir) { let n = curT + dir; if(n >= 0 && n < library[curV].tracks.length) playTrack(curV, n); }
    </script>
</body>
</html>
