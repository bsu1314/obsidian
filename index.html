<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[obsidian]</title>
    <link rel="icon" type="image/png" href="https://static.wikia.nocookie.net/minecraft_gamepedia/images/9/99/Obsidian_JE3_BE2.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root { --bg: #050505; --gray: #555; --border: #1a1a1a; --active: #ff0436; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; text-transform: uppercase; }
        aside { width: 260px; border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; background: #000; z-index: 10; flex-shrink: 0; }
        #logoBtn { font-weight: bold; margin-bottom: 30px; cursor: pointer; letter-spacing: 2px; color: #fff; font-size: 1.2rem; }
        nav { flex-grow: 1; overflow-y: auto; scrollbar-width: none; }
        .nav-item { color: var(--gray); display: flex; align-items: center; gap: 10px; font-size: 0.7rem; cursor: pointer; margin-bottom: 15px; transition: 0.2s; padding: 5px; border-radius: 4px; }
        .nav-item:hover, .nav-item.active { color: #fff; }
        .nav-item img { width: 18px; height: 18px; object-fit: cover; border-radius: 2px; }
        
  
        .nav-item.playing-now { color: #fff !important; background: rgba(255, 4, 54, 0.15); border-left: 2px solid var(--active); font-weight: bold; }
        
        #fxPanel { display: none; background: #080808; border: 1px solid var(--border); padding: 12px; margin-bottom: 20px; }
        .fx-row { margin-bottom: 12px; }
        .fx-row label { font-size: 0.5rem; color: var(--gray); display: flex; justify-content: space-between; margin-bottom: 4px; }
        input[type="range"] { width: 100%; -webkit-appearance: none; background: #222; height: 1px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); cursor: pointer; }
        main { flex-grow: 1; position: relative; overflow: hidden; }
        .state-container { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; padding-bottom: 120px; }
        #dropZone { width: 450px; height: 250px; border: 1px dashed var(--gray); display: flex; flex-direction: column; align-items: center; justify-content: center; background: #080808; cursor: pointer; }
        .vault-content { padding: 40px; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .vault-header { display: flex; gap: 30px; margin-bottom: 40px; align-items: flex-start; }
        .cover-art { width: 160px; height: 160px; background: #111; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .cover-art img { width: 100%; height: 100%; object-fit: cover; }
        .track-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #111; font-size: 0.7rem; color: var(--gray); gap: 15px; cursor: pointer; }
        .track-row:hover { background: #0a0a0a; color: #fff; }
        .track-row.active { color: var(--active); background: #0a0000; }
        .track-title-input { background: none; border: none; color: inherit; font-family: inherit; font-size: inherit; text-transform: uppercase; width: 100%; outline: none; pointer-events: auto; }
        .trade-icon { font-size: 18px !important; cursor: pointer; opacity: 0.4; }
        .trade-icon:hover { opacity: 1; color: var(--active); }
        #playerBar { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: #000; border-top: 1px solid var(--border); display: none; flex-direction: column; z-index: 100; }
        #seekBar { width: 100%; height: 2px; -webkit-appearance: none; background: #111; cursor: pointer; outline: none; }
        #seekBar::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: var(--active); }
    </style>
</head>
<body>

    <aside>
        <div id="logoBtn" onclick="location.reload()">[obsidian]</div>
        <nav>
            <div class="nav-item" onclick="showState('homeState')"><span class="material-symbols-outlined">add</span>NEW PROJECT</div>
            <div class="nav-item" onclick="showState('gridState')"><span class="material-symbols-outlined">grid_view</span>ALL PROJECTS</div>
            <div class="nav-item" onclick="toggleFx()"><span class="material-symbols-outlined">tune</span> FX </div>
            <div id="fxPanel">
                <canvas id="vCanvas" width="210" height="40" style="margin-bottom:10px;"></canvas>
                <div class="fx-row"><label>PITCH <span id="v1">1.0</span></label><input type="range" id="f1" min="0.5" max="1.5" step="0.01" value="1"></div>
                <div class="fx-row"><label>LOWPASS <span id="v2">22000</span></label><input type="range" id="f2" min="20" max="22000" step="1" value="22000"></div>
                <div class="fx-row"><label>HIGHPASS <span id="v3">0</span></label><input type="range" id="f3" min="0" max="5000" step="1" value="0"></div>
                <div class="fx-row"><label>DISTORT <span id="v4">0</span></label><input type="range" id="f4" min="0" max="100" step="1" value="0"></div>
                <div class="fx-row"><label>BASS <span id="v5">0</span></label><input type="range" id="f5" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>MID <span id="v6">0</span></label><input type="range" id="f6" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>TREBLE <span id="v7">0</span></label><input type="range" id="f7" min="-20" max="20" step="1" value="0"></div>
                <div class="fx-row"><label>COMPRESS <span id="v8">-24</span></label><input type="range" id="f8" min="-60" max="0" step="1" value="-24"></div>
                <div class="fx-row"><label>PAN <span id="v9">0</span></label><input type="range" id="f9" min="-1" max="1" step="0.01" value="0"></div>
                <div class="fx-row"><label>MASTER <span id="v10">1.0</span></label><input type="range" id="f10" min="0" max="2" step="0.01" value="1"></div>
                <button onclick="resetFX()" style="width:100%; background:#111; color:var(--active); border:1px solid #333; font-size:0.5rem; padding:8px; cursor:pointer;">RESET FX</button>
            </div>
            <hr style="border:0; border-top:1px solid #111; margin:15px 0;">
            <div id="sideProjects"></div>
        </nav>
    </aside>

    <main>
        <div id="homeState" class="state-container" style="display:flex;">
            <div style="display:flex; align-items:center; justify-content:center; height:100vh; width:100%;">
                <div id="dropZone" onclick="document.getElementById('fileIn').click()">
                    <span class="material-symbols-outlined" style="font-size:40px;">cloud_upload</span>
                    <div style="font-size:0.6rem; margin-top:15px;">DRAG AND DROP OR SELECT AUDIO FILE</div>
                    <input type="file" id="fileIn" multiple accept="audio/*" style="display:none;">
                </div>
            </div>
        </div>
        <div id="gridState" class="state-container"><div id="gridItems" style="padding:40px; display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:25px;"></div></div>
        <div id="vaultState" class="state-container">
            <div class="vault-content">
                <div class="vault-header">
                    <div style="display:flex; flex-direction:column; align-items:center; gap:15px;">
                        <div class="cover-art" onclick="document.getElementById('coverIn').click()">
                            <img id="vCover" src="" style="display:none;"><span id="vIcon" class="material-symbols-outlined">image</span>
                            <input type="file" id="coverIn" accept="image/*" style="display:none;">
                        </div>
                        <span class="material-symbols-outlined" id="bigPlayBtn" style="font-size:60px; color:var(--active); cursor:pointer;" onclick="toggleMainPlay()">play_circle</span>
                    </div>
                    <div style="flex-grow:1; padding-top: 10px;">
                        <input type="text" id="vTitle" placeholder="PROJECT TITLE" style="background:none; border:none; color:#fff; font-size:2.5rem; font-weight:bold; outline:none; width:100%;">
                        <input type="text" id="vArtist" placeholder="ARTIST" style="background:none; border:none; color:var(--gray); font-size:0.9rem; outline:none; width:100%;">
                        <div style="margin-top:25px; display:flex; gap:10px;">
                            <button onclick="document.getElementById('appendIn').click()" style="font-size:0.5rem; background:#111; color:#eee; border:1px solid #333; padding:8px 15px; cursor:pointer;">+ ADD TRACKS</button>
                            <button onclick="deleteProject()" style="font-size:0.5rem; background:#111; color:var(--active); border:1px solid #333; padding:8px 15px; cursor:pointer;">DELETE PROJECT</button>
                            <input type="file" id="appendIn" multiple accept="audio/*" style="display:none;">
                        </div>
                    </div>
                </div>
                <div id="trackList"></div>
            </div>
        </div>
    </main>

    <input type="file" id="tradeIn" accept="audio/*" style="display:none;">

    <footer id="playerBar">
        <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 40px;">
            <div style="display:flex; align-items:center; gap:15px; width:300px;">
                <img id="pThumb" style="width:40px; height:40px; object-fit:cover; border:1px solid #222;">
                <div><div id="pTrack" style="font-size:0.7rem; color:var(--active); font-weight:bold;">---</div><div id="pProj" style="font-size:0.5rem; color:var(--gray);">---</div></div>
            </div>
            <div style="display:flex; gap:30px; align-items:center;">
                <span class="material-symbols-outlined" onclick="prevNext(-1)" style="cursor:pointer">skip_previous</span>
                <span class="material-symbols-outlined" id="playBtn" style="cursor:pointer; font-size:35px;" onclick="toggleAudio()">play_circle</span>
                <span class="material-symbols-outlined" onclick="prevNext(1)" style="cursor:pointer">skip_next</span>
            </div>
            <div style="width:100px;"></div>
        </div>
    </footer>

    <script>
        let db=null, library=[], curV=null, curT=null, audio=new Audio();
        let playingProjectId=null, tradeIdx=null, draggedIdx=null;
        let ctx, source, analyzer, master, panner, lp, hp, dist, bass, mid, treble, comp;

        const openDB = () => new Promise(res => {
            const req = indexedDB.open("ObsidianStudioFinal", 1);
            req.onupgradeneeded = e => { e.target.result.createObjectStore("projects", { keyPath: "id", autoIncrement: true }); };
            req.onsuccess = e => { db = e.target.result; res(db); };
        });

        function initAudio() {
            if (ctx) return;
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            source = ctx.createMediaElementSource(audio);
            analyzer = ctx.createAnalyser();
            master = ctx.createGain();
            panner = ctx.createStereoPanner();
            lp = ctx.createBiquadFilter(); lp.type = "lowpass";
            hp = ctx.createBiquadFilter(); hp.type = "highpass";
            dist = ctx.createWaveShaper();
            comp = ctx.createDynamicsCompressor();
            bass = ctx.createBiquadFilter(); bass.type = "lowshelf"; bass.frequency.value = 200;
            mid = ctx.createBiquadFilter(); mid.type = "peaking"; mid.frequency.value = 1000;
            treble = ctx.createBiquadFilter(); treble.type = "highshelf"; treble.frequency.value = 3000;
            
            source.connect(dist).connect(lp).connect(hp).connect(bass).connect(mid).connect(treble).connect(panner).connect(comp).connect(master).connect(analyzer).connect(ctx.destination);
            drawVisualizer();
        }

        async function sync() {
            if(!db) await openDB();
            db.transaction("projects", "readonly").objectStore("projects").getAll().onsuccess = e => { 
                library = e.target.result; renderSidebar(); renderGrid(); if (curV !== null) renderProject(curV);
            };
        }

        function showState(id) { document.querySelectorAll('.state-container').forEach(s => s.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }
        
        function toggleAudio() { if(!audio.src) return; audio.paused ? audio.play() : audio.pause(); syncUI(); }
        
        function playTrack(vi, ti) {
            initAudio();
            if (playingProjectId === library[vi].id && curT === ti) { toggleAudio(); return; }
            curV = vi; curT = ti; playingProjectId = library[vi].id;
            if(audio.src) URL.revokeObjectURL(audio.src);
            audio.src = URL.createObjectURL(new Blob([library[vi].tracks[ti].data]));
            updateFX(); 
            audio.play(); syncUI();
        }

        function toggleMainPlay() {
            if (playingProjectId && curV !== null && playingProjectId === library[curV].id) toggleAudio();
            else if (curV !== null && library[curV] && library[curV].tracks.length > 0) playTrack(curV, 0);
        }

        function syncUI() {
            const isPaused = audio.paused;
            document.getElementById('playBtn').innerText = isPaused ? 'play_circle' : 'pause_circle';
            
         
            const bigBtn = document.getElementById('bigPlayBtn');
            if (curV !== null && library[curV] && playingProjectId === library[curV].id) {
                bigBtn.innerText = isPaused ? 'play_circle' : 'pause_circle';
            } else {
                bigBtn.innerText = 'play_circle';
            }

            document.querySelectorAll('.track-play-icon').forEach((icon, i) => {
                icon.innerText = (playingProjectId === library[curV].id && curT === i && !isPaused) ? 'pause' : 'play_arrow';
            });
            
            if (playingProjectId) {
                const p = library.find(x => x.id === playingProjectId);
                document.getElementById('playerBar').style.display = 'flex';
                document.getElementById('pTrack').innerText = p.tracks[curT]?.title || "---";
                document.getElementById('pProj').innerText = p.title;
                document.getElementById('pThumb').src = p.cover || '';
            }
            renderSidebar();
        }

        function renderProject(idx) {
            curV = idx; const p = library[idx]; showState('vaultState');
            document.getElementById('vTitle').value = p.title;
            document.getElementById('vArtist').value = p.artist;
            document.getElementById('vCover').src = p.cover || '';
            document.getElementById('vCover').style.display = p.cover ? 'block' : 'none';
            document.getElementById('vIcon').style.display = p.cover ? 'none' : 'block';
            const list = document.getElementById('trackList'); list.innerHTML = '';
            p.tracks.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = `track-row ${ (playingProjectId===p.id && curT===i) ? 'active' : ''}`;
                row.draggable = true;
                row.innerHTML = `
                    <span class="material-symbols-outlined" style="font-size:14px; opacity:0.2; cursor:grab;">drag_indicator</span>
                    <span class="material-symbols-outlined track-play-icon" style="font-size:18px;">play_arrow</span>
                    <div style="flex-grow:1"><input type="text" class="track-title-input" value="${t.title}"></div>
                    <span class="material-symbols-outlined trade-icon">swap_calls</span>
                    <span class="material-symbols-outlined del-icon" style="font-size:14px; opacity:0.3;">delete</span>
                `;
                
                row.ondragstart = () => { draggedIdx = i; row.style.opacity = "0.4"; };
                row.ondragend = () => { draggedIdx = null; row.style.opacity = "1"; document.querySelectorAll('.track-row').forEach(r => r.style.borderTop = "none"); };
                row.ondragover = e => { e.preventDefault(); if (draggedIdx !== null && draggedIdx !== i) row.style.borderTop = "2px solid var(--active)"; };
                row.ondragleave = () => row.style.borderTop = "none";
                row.ondrop = () => {
                    row.style.borderTop = "none";
                    if (draggedIdx === null || draggedIdx === i) return;
                    const movedItem = p.tracks.splice(draggedIdx, 1)[0];
                    p.tracks.splice(i, 0, movedItem);
                    if (playingProjectId === p.id) {
                        if (curT === draggedIdx) curT = i;
                        else if (draggedIdx < curT && i >= curT) curT--;
                        else if (draggedIdx > curT && i <= curT) curT++;
                    }
                    save();
                };

                const input = row.querySelector('.track-title-input');
                input.onblur = (e) => { updateTrackTitle(i, e.target.value); };
                input.onclick = (e) => { e.stopPropagation(); };
                row.querySelector('.trade-icon').onclick = (e) => { e.stopPropagation(); tradeIdx=i; document.getElementById('tradeIn').click(); };
                row.querySelector('.del-icon').onclick = (e) => { e.stopPropagation(); removeTrack(i, e.shiftKey); };
                row.onclick = () => playTrack(idx, i);
                list.appendChild(row);
            });
            syncUI();
        }

        async function save() { if(curV===null) return; library[curV].title = document.getElementById('vTitle').value.toUpperCase(); library[curV].artist = document.getElementById('vArtist').value.toUpperCase(); db.transaction("projects", "readwrite").objectStore("projects").put(library[curV]).onsuccess = () => sync(); }
        function updateTrackTitle(ti, val) { library[curV].tracks[ti].title = val.toUpperCase(); save(); }
        function removeTrack(ti, skipConfirm) { 
            if(skipConfirm || confirm("DELETE TRACK?")) {
                library[curV].tracks.splice(ti, 1); 
                save(); 
            }
        }
        function deleteProject() { 
            const skipConfirm = window.event && window.event.shiftKey;
            if(skipConfirm || confirm("DELETE PROJECT?")) { 
                db.transaction("projects", "readwrite").objectStore("projects").delete(library[curV].id).onsuccess = () => { curV=null; sync(); showState('homeState'); }; 
            } 
        }

        function renderSidebar() {
            const s = document.getElementById('sideProjects'); s.innerHTML = '';
            library.forEach((p, i) => {
                const d = document.createElement('div');
                const isPlaying = playingProjectId === p.id;
                d.className = `nav-item ${curV===i?'active':''} ${isPlaying?'playing-now':''}`;
                d.innerHTML = `${p.cover ? `<img src="${p.cover}">` : `<span class="material-symbols-outlined">album</span>`} ${p.title}`;
                d.onclick = () => renderProject(i);
                s.appendChild(d);
            });
        }

        function renderGrid() {
            const g = document.getElementById('gridItems'); g.innerHTML = '';
            library.forEach((p, i) => {
                const c = document.createElement('div');
                c.style.cssText = "border:1px solid #1a1a1a; padding:20px; background:#080808; cursor:pointer;";
                c.innerHTML = `<img src="${p.cover || ''}" style="width:100%; aspect-ratio:1; background:#111; object-fit:cover;"><div style="margin-top:10px; font-size:0.6rem;">${p.title}</div>`;
                c.onclick = () => renderProject(i);
                g.appendChild(c);
            });
        }

        async function handleFiles(files, append = false) {
            const tracks = [];
            for(let f of Array.from(files)) {
                const data = await f.arrayBuffer();
                tracks.push({ title: f.name.replace(/\.[^/.]+$/, "").toUpperCase(), data });
            }
            if(append) { library[curV].tracks.push(...tracks); save(); }
            else { db.transaction("projects", "readwrite").objectStore("projects").add({ title: "NEW PROJECT", artist: "UNKNOWN", tracks, cover: null }).onsuccess = () => sync(); }
        }

        document.getElementById('tradeIn').onchange = async (e) => {
            const f = e.target.files[0];
            if(f && tradeIdx !== null) {
                library[curV].tracks[tradeIdx].data = await f.arrayBuffer();
                if(playingProjectId === library[curV].id && curT === tradeIdx) { audio.src = URL.createObjectURL(new Blob([library[curV].tracks[tradeIdx].data])); audio.play(); }
                save();
            }
            e.target.value = ''; tradeIdx = null;
        };

        const dz = document.getElementById('dropZone');
        dz.ondragover = e => { e.preventDefault(); dz.style.borderColor = "#ff0436"; };
        dz.ondragleave = () => dz.style.borderColor = "#555";
        dz.ondrop = e => { e.preventDefault(); dz.style.borderColor = "#555"; handleFiles(e.dataTransfer.files); };

        function toggleFx() { const p = document.getElementById('fxPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function resetFX() { for(let i=1; i<=10; i++) { const s = document.getElementById('f'+i); s.value = s.defaultValue; } updateFX(); }
        
        function updateFX() {
            if(!ctx) return;
            const v = (id) => parseFloat(document.getElementById(id).value);
            audio.playbackRate = v('f1');
            lp.frequency.setTargetAtTime(v('f2'), ctx.currentTime, 0.01);
            hp.frequency.setTargetAtTime(v('f3'), ctx.currentTime, 0.01);
            dist.curve = v('f4') > 0 ? makeDistCurve(v('f4')) : null;
            bass.gain.setTargetAtTime(v('f5'), ctx.currentTime, 0.01);
            mid.gain.setTargetAtTime(v('f6'), ctx.currentTime, 0.01);
            treble.gain.setTargetAtTime(v('f7'), ctx.currentTime, 0.01);
            comp.threshold.setTargetAtTime(v('f8'), ctx.currentTime, 0.01);
            panner.pan.setTargetAtTime(v('f9'), ctx.currentTime, 0.01);
            master.gain.setTargetAtTime(v('f10'), ctx.currentTime, 0.01);
            for(let i=1; i<=10; i++) document.getElementById('v'+i).innerText = document.getElementById('f'+i).value;
        }

        function makeDistCurve(amount) {
            let n = 44100, curve = new Float32Array(n);
            for (let i=0; i<n; i++) { let x = i*2/n-1; curve[i] = (3+amount)*x*Math.PI/(Math.PI+amount*Math.abs(x)); }
            return curve;
        }

        function drawVisualizer() {
            const canvas = document.getElementById('vCanvas'), c = canvas.getContext('2d'), data = new Uint8Array(analyzer.frequencyBinCount);
            const draw = () => {
                requestAnimationFrame(draw); analyzer.getByteFrequencyData(data);
                c.fillStyle = '#080808'; c.fillRect(0,0,canvas.width,canvas.height);
                for(let i=0; i<canvas.width; i++) {
                    const h = (data[i]/255)*canvas.height;
                    c.fillStyle = i%2===0 ? '#ff0436' : '#222';
                    c.fillRect(i*2, canvas.height-h, 1, h);
                }
            }; draw();
        }

        document.querySelectorAll('#fxPanel input').forEach(i => i.oninput = updateFX);
        audio.ontimeupdate = () => { document.getElementById('seekBar').value = (audio.currentTime/audio.duration)*100 || 0; };
        document.getElementById('seekBar').oninput = e => { audio.currentTime = (e.target.value/100) * audio.duration; };
        audio.onplay = syncUI; audio.onpause = syncUI; audio.onended = () => prevNext(1);
        function prevNext(dir) { let n = curT + dir; if(library.find(x=>x.id===playingProjectId)?.tracks[n]) playTrack(library.findIndex(x=>x.id===playingProjectId), n); }
        document.getElementById('fileIn').onchange = e => handleFiles(e.target.files);
        document.getElementById('appendIn').onchange = e => handleFiles(e.target.files, true);
        document.getElementById('vTitle').onblur = save; document.getElementById('vArtist').onblur = save;
        document.getElementById('coverIn').onchange = e => {
            const f = e.target.files[0], r = new FileReader();
            r.onload = () => { library[curV].cover = r.result; save(); };
            if(f) r.readAsDataURL(f);
        };
        window.onkeydown = e => { if(e.code === 'Space' && e.target.tagName !== 'INPUT') { e.preventDefault(); toggleAudio(); } };
        openDB().then(() => sync());
    </script>
</body>
</html>
